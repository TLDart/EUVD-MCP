"""
Pydantic models for EUVD vulnerability and advisory data.
"""

from typing import Any, List

from pydantic import BaseModel, Field, RootModel


# Base models
class Product(BaseModel):
    """Model representing a product."""

    name: str | None = Field(None, description="Product name")
    model_config = {"extra": "allow", "populate_by_name": True}


class Vendor(BaseModel):
    """Model representing a vendor."""

    name: str | None = Field(None, description="Vendor name")
    model_config = {"extra": "allow", "populate_by_name": True}


class Source(BaseModel):
    """Model representing the source of an advisory."""

    id: int | None = Field(None, description="Source ID")
    name: str | None = Field(None, description="Source name")
    model_config = {"extra": "allow", "populate_by_name": True}


# Vulnerability-related models
class EnisaIdProduct(BaseModel):
    """Model representing product information for an ENISA ID."""

    id: str | None = Field(None, description="ENISA ID product ID")
    product: Product | None = Field(None, description="Product information")
    product_version: str | None = Field(None, description="Product version")
    model_config = {"extra": "allow", "populate_by_name": True}


class EnisaIdVendor(BaseModel):
    """Model representing vendor information for an ENISA ID."""

    id: str | None = Field(None, description="ENISA ID vendor ID")
    vendor: Vendor | None = Field(None, description="Vendor information")
    model_config = {"extra": "allow", "populate_by_name": True}


class VulnerabilityProduct(BaseModel):
    """Model representing product information for a vulnerability."""

    id: str | None = Field(None, description="Vulnerability product ID")
    product: Product | None = Field(None, description="Product information")
    product_version: str | None = Field(None, description="Product version")
    model_config = {"extra": "allow", "populate_by_name": True}


class VulnerabilityVendor(BaseModel):
    """Model representing vendor information for a vulnerability."""

    id: str | None = Field(None, description="Vulnerability vendor ID")
    vendor: Vendor | None = Field(None, description="Vendor information")
    model_config = {"extra": "allow", "populate_by_name": True}


class VulnerabilityVulnerability(BaseModel):
    """Model representing a nested vulnerability within an ENISA ID vulnerability."""

    id: str | None = Field(None, description="Vulnerability ID (CVE)")
    description: str | None = Field(None, description="Vulnerability description")
    date_published: str | None = Field(None, alias="datePublished", description="Publication date")
    date_updated: str | None = Field(None, alias="dateUpdated", description="Last update date")
    status: str | None = Field(None, description="Vulnerability status")
    base_score: float | None = Field(None, alias="baseScore", description="CVSS base score")
    references: str | None = Field(None, description="Reference URLs (newline-separated)")
    enisa_id: str | None = Field(None, description="ENISA ID")
    assigner: str | None = Field(None, description="CVE assigner")
    epss: float | None = Field(None, description="EPSS score")
    data_processed: str | None = Field(None, alias="dataProcessed", description="Data processing date")
    vulnerability_product: List[VulnerabilityProduct] | None = Field(
        None, alias="vulnerabilityProduct", description="Product information"
    )
    vulnerability_vendor: List[VulnerabilityVendor] | None = Field(
        None, alias="vulnerabilityVendor", description="Vendor information"
    )
    model_config = {"extra": "allow", "populate_by_name": True}


class EnisaIdVulnerability(BaseModel):
    """Model representing a vulnerability within an ENISA ID."""

    id: str | None = Field(None, description="ENISA ID vulnerability ID")
    vulnerability: VulnerabilityVulnerability | None = Field(None, description="Vulnerability information")
    model_config = {"extra": "allow", "populate_by_name": True}


class EnisaId(BaseModel):
    """Model representing an ENISA ID within an advisory."""

    id: str | None = Field(None, description="ENISA ID")
    enisa_uuid: str | None = Field(None, alias="enisaUuid", description="ENISA UUID")
    description: str | None = Field(None, description="Description")
    date_published: str | None = Field(None, alias="datePublished", description="Publication date")
    date_updated: str | None = Field(None, alias="dateUpdated", description="Last update date")
    base_score: float | None = Field(None, alias="baseScore", description="CVSS base score")
    base_score_version: str | None = Field(None, alias="baseScoreVersion", description="CVSS version")
    base_score_vector: str | None = Field(None, alias="baseScoreVector", description="CVSS vector")
    references: str | None = Field(None, description="Reference URLs (newline-separated)")
    aliases: str | None = Field(None, description="CVE aliases (newline-separated)")
    assigner: str | None = Field(None, description="CVE assigner")
    epss: float | None = Field(None, description="EPSS score")
    model_config = {"extra": "allow", "populate_by_name": True}


class EnisaIdAdvisory(BaseModel):
    """Model representing an ENISA ID advisory entry."""

    id: str | None = Field(None, description="ENISA ID advisory ID")
    enisa_id: EnisaId | None = Field(None, alias="enisaId", description="ENISA ID information")
    enisa_id_vendor: List[EnisaIdVendor] | None = Field(None, alias="enisaIdVendor", description="Vendor information")
    model_config = {"extra": "allow", "populate_by_name": True}


class Vulnerability(BaseModel):
    """
    Model representing a vulnerability from the EUVD database.
    """

    id: str | None = Field(None, description="ENISA vulnerability ID")
    enisa_uuid: str | None = Field(None, alias="enisaUuid", description="ENISA UUID")
    description: str | None = Field(None, description="Vulnerability description")
    date_published: str | None = Field(None, alias="datePublished", description="Publication date")
    date_updated: str | None = Field(None, alias="dateUpdated", description="Last update date")
    base_score: float | None = Field(None, alias="baseScore", description="CVSS base score")
    base_score_version: str | None = Field(None, alias="baseScoreVersion", description="CVSS version")
    base_score_vector: str | None = Field(None, alias="baseScoreVector", description="CVSS vector")
    references: str | None = Field(None, description="Reference URLs (newline-separated)")
    aliases: str | None = Field(None, description="CVE aliases (newline-separated)")
    assigner: str | None = Field(None, description="CVE assigner")
    epss: float | None = Field(None, description="EPSS score")
    enisa_id_product: List[EnisaIdProduct] | None = Field(None, alias="enisaIdProduct", description="Product information")
    enisa_id_vendor: List[EnisaIdVendor] | None = Field(None, alias="enisaIdVendor", description="Vendor information")
    enisa_id_vulnerability: List[EnisaIdVulnerability] | None = Field(
        None, alias="enisaIdVulnerability", description="Vulnerability information"
    )
    enisa_id_advisory: List[EnisaIdAdvisory] | None = Field(None, alias="enisaIdAdvisory", description="Advisory information")
    # Allow additional fields that might be present in the API response
    model_config = {"extra": "allow", "populate_by_name": True}


class VulnerabilityListResponse(RootModel[List[Vulnerability]]):
    """
    Model representing a list response for vulnerabilities.

    EUVD endpoints return a raw JSON array.
    """

    # __root__ is replaced by .root in Pydantic v2

    def __iter__(self) -> Any:
        """Return an iterator over the vulnerabilities."""
        return iter(self.root)

    def __len__(self) -> int:
        """Return the number of vulnerabilities."""
        return len(self.root)

    @property
    def vulnerabilities(self) -> List[Vulnerability]:
        """Get the list of vulnerabilities."""
        return self.root


class ExploitedVulnerabilities(BaseModel):
    """
    Model representing a list of exploited vulnerabilities.
    """

    list: List[Vulnerability] = Field(..., description="List of exploited vulnerabilities")


class SearchResponse(BaseModel):
    """
    Model representing a search response with pagination.
    """

    content: List[Vulnerability] | None = Field(None, description="List of vulnerabilities in current page")
    data: List[Vulnerability] | None = Field(None, description="Alternative field name for content")
    vulnerabilities: List[Vulnerability] | None = Field(None, description="Alternative field name for content")
    total_elements: int | None = Field(None, alias="totalElements", description="Total number of elements")
    total: int | None = Field(None, description="Total number of elements (alternative)")
    total_pages: int | None = Field(None, alias="totalPages", description="Total number of pages")
    page: int | None = Field(None, description="Current page number")
    size: int | None = Field(None, description="Page size")
    # Allow additional fields
    model_config = {"extra": "allow", "populate_by_name": True}

    def __iter__(self) -> Any:
        """Allow iteration over vulnerabilities."""
        vulns = self.content or self.data or self.vulnerabilities or []
        return iter(vulns)

    def __len__(self) -> int:
        """Return the number of vulnerabilities in current page."""
        vulns = self.content or self.data or self.vulnerabilities or []
        return len(vulns)


# Advisory-related models
class AdvisoryProduct(BaseModel):
    """Model representing an advisory product."""

    id: str | None = Field(None, description="Advisory product ID")
    product: Product | None = Field(None, description="Product information")
    model_config = {"extra": "allow", "populate_by_name": True}


class AdvisoryVulnerability(BaseModel):
    """Model representing a vulnerability within an advisory."""

    id: str | None = Field(None, description="Vulnerability ID (CVE)")
    description: str | None = Field(None, description="Vulnerability description")
    date_published: str | None = Field(None, alias="datePublished", description="Publication date")
    date_updated: str | None = Field(None, alias="dateUpdated", description="Last update date")
    status: str | None = Field(None, description="Vulnerability status")
    base_score: float | None = Field(None, alias="baseScore", description="CVSS base score")
    base_score_version: str | None = Field(None, alias="baseScoreVersion", description="CVSS version")
    base_score_vector: str | None = Field(None, alias="baseScoreVector", description="CVSS vector")
    references: str | None = Field(None, description="Reference URLs (newline-separated)")
    enisa_id: str | None = Field(None, description="ENISA ID")
    assigner: str | None = Field(None, description="CVE assigner")
    epss: float | None = Field(None, description="EPSS score")
    data_processed: str | None = Field(None, alias="dataProcessed", description="Data processing date")
    model_config = {"extra": "allow", "populate_by_name": True}


class VulnerabilityAdvisory(BaseModel):
    """
    Model representing a vulnerability advisory entry.
    """

    id: str | None = Field(None, description="Vulnerability advisory ID")
    vulnerability: AdvisoryVulnerability | None = Field(None, description="Vulnerability information")
    vulnerability_vendor: List[VulnerabilityVendor] | None = Field(
        None, alias="vulnerabilityVendor", description="Vendor information"
    )
    model_config = {"extra": "allow", "populate_by_name": True}


class Advisory(BaseModel):
    """
    Model representing a security advisory from the EUVD database.
    """

    id: str | None = Field(None, description="Advisory ID")
    description: str | None = Field(None, description="Advisory description")
    summary: str | None = Field(None, description="Advisory summary")
    date_published: str | None = Field(None, alias="datePublished", description="Publication date")
    date_updated: str | None = Field(None, alias="dateUpdated", description="Last update date")
    base_score: float | None = Field(None, alias="baseScore", description="CVSS base score")
    references: str | None = Field(None, description="Reference URLs (newline-separated)")
    aliases: str | None = Field(None, description="CVE aliases (newline-separated)")
    source: Source | None = Field(None, description="Advisory source")
    advisory_product: List[AdvisoryProduct] | None = Field(None, alias="advisoryProduct", description="Affected products")
    enisa_id_advisories: List[EnisaIdAdvisory] | None = Field(
        None, alias="enisaIdAdvisories", description="ENISA ID advisories"
    )
    vulnerability_advisory: List[VulnerabilityAdvisory] | None = Field(
        None, alias="vulnerabilityAdvisory", description="Vulnerability advisories"
    )
    # Allow additional fields
    model_config = {"extra": "allow", "populate_by_name": True}
